name: Test and Deploy to Amplify

on:
  # Trigger this workflow whenever code is pushed to the 'main' branch
  push:
    branches: ["main"]
  # Also allow running manually from the Actions tab if needed
  workflow_dispatch:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js (matches the version you use)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. Install Dependencies (Using your specific fix)
      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # 4. Run Tests
      # If this step FAILS, the pipeline stops here. Amplify is never triggered.
      - name: Run Tests
        run: CI=true npm test

      # 5. Trigger AWS Amplify Deploy
      # This only runs if the previous steps passed
      - name: Trigger Amplify Build
        if: success()
        run: curl -X POST -d {} "${{ secrets.AMPLIFY_WEBHOOK_URL }}" -H "Content-Type:application/json"
